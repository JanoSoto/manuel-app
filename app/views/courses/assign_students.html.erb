<!-- Content Header (Page header) -->
<section class="content-header">
  <h1>
    Ver curso
    <small>Ver toda la información de un curso</small>
  </h1>
  <ol class="breadcrumb">
    <li><a href="<%= courses_path %>">Cursos</a></li>
    <li><a href="<%= course_path(@course) %>"><%= @course.name %></a></li>
    <li class="active">Asignar estudiantes</li>
  </ol>
</section>

<!-- Main content -->
<section class="content">
  <div class="row">
    <div class="col-xs-12">
      <%= link_to course_path(@course) do %>
        <i class="fa fa-arrow-left"></i> Volver
      <% end %>
    </div>
  </div>
  <div class="row">
    <br>
    <div class="col-xs-12 col-md-6">
      <div class="box box-primary">
        <div class="box-header with-border">
          <h3 class="box-title">Estudiantes registrados</h3>
          <p>Haga click sobre los estudiantes que desea asignar al curso</p>
        </div>
        <div class="box-body" id="available-students">
          <% @unassigned_students.each do |student| %>
            <button id="student<%= student.id %>" class="btn btn-default student-button" onclick="assignStudent(<%= student.id %>, <%= @course.id %>, null)"><%= student.email %></button>
          <% end %>
        </div>
        <div class="box-footer">
          <i class="fa fa-info-circle primary"></i> Click derecho para asignar como ayudante
        </div>
      </div>
    </div>
    <div class="col-xs-12 col-md-6">
      <div class="box box-success">
        <div class="box-header with-border">
          <h3 class="box-title">Estudiantes asignados</h3>
          <p>Haga click sobre los estudiantes que desea quitar del curso</p>
        </div>
        <div class="box-body" id="assigned-students">
          <% @assigned_students.each do |student| %>
            <button id="student<%= student[:id] %>" class="btn <%= student[:role] == 'ayudante' ? 'btn-primary' : 'btn-default' %> student-button" onclick="removeStudent(<%= student[:id] %>, <%= @course.id %>, null)"><%= student[:email] %></button>
          <% end %>
        </div>
        <div class="box-footer">
          <span class="label label-primary">Ayudante</span>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- /.content -->

<script>
  function assignStudent(student_id, course_id, role){
    $.post('<%= assign_student_to_course_path %>',
          {
            course_id: course_id,
            student_id: student_id,
            role: role
          })
          .done(function(data){
            if (role == 'ayudante') {
              $('#assigned-students').append($('#student'+student_id).remove().attr('onclick', 'removeStudent('+student_id+','+course_id+', null)').removeClass('btn-default').addClass('btn-primary'));
            }
            else {
              $('#assigned-students').append($('#student'+student_id).remove().attr('onclick', 'removeStudent('+student_id+','+course_id+', null)'));
            }
            toastr['info']('Estudiante asignado con éxito');
          });
  }

  function removeStudent(student_id, course_id, role){
    $.post('<%= remove_student_from_course_path %>',
          {
            course_id: course_id,
            student_id: student_id,
            role: role
          })
          .done(function(data){
            $('#available-students').append($('#student'+student_id).remove().attr('onclick', 'assignStudent('+student_id+','+course_id+', null)'));
            toastr['info']('Estudiante removido con éxito');
          });
  }

  $(function() {
    $.contextMenu({
      selector: '.student-button', 
      callback: function(key, options) {
        var args = $(this).attr('onclick').split('(')[1].split(',');
        assignStudent(args[0], args[1], 'ayudante');
      },
      items: {
        "assitant": {name: "Asignar como ayudante"}
      }
    });
  
  });
</script>